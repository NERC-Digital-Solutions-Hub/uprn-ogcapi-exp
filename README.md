# uprn-ogcapi-exp

This repository contains an experimental solution for creating an API for serving geospatial vector features from a PostGIS database. The project is built using the OgcApi.Net package extensively, with custom middleware extending existing endpoint functionality with additional query parameters. The learnings from this project have been used to modify OgcApi.Net for better performance on large tables via making the query match count optional. This change is instrumental for the performance of this solution and will have to be integrated into OgcApi.Net with a PR.

## Post-cloning actions to run the project

- If you want to run in Debug mode through Visual Studio, set the `NDSH.Geospatial.Uprn.Service` project as the Startup Project. 
- Add the connection string to the database you wish to use as either a user secret to the `NDSH.Geospatial.Uprn.Service` project or, if you are running in a production environment, as an environment variable named `ConnectionStrings__PostgresConnectionString`, there is an example in `appsettings.json` regarding its formatting.

## Endpoints

The API has all the endpoints automatically generated by OgcApi.Net, but some of them have been extended with additional query parameters. The endpoints are the following:

| Endpoint path | Description |
| :------------ | :---------- |
| `/`             | Base path, provides links to conformance, landing page, etc. |
| `/conformance`  | Conformance document, listing OGC standards conformed to |
| `/collections`  | All feature and/or tile collections available through the API |
| `/collections/{collectionId}` | Metadata about a collection |
| `/collections/{collectionId}/items` | Returns multiple items from the collection |
| `/collections/{collectionId}/items/{featureId}` | Returns a singular feature from the collection based on its identifier |
| `/collections/{collectionId}/schema` | Returns information about the schema of a collection, including field names and data types |
| `/collections/{collectionId}/queryables` | Returns queryable properties of a collection, in practice the same as the schema endpoint |
| `/collections/{collectionId}/sortables` | Returns an empty schema object, not yet used by OgcApi.Net |

## Changes

In this experimental solution, the following endpoints have been changed:

| Endpoint | Change |
| :------- | :----- |
| `/collections/{collectionId}/items` | Added the `fields` parameter for filtering response properties. Added the `selectorSource` and `selectorIds` fields to return only items that intersect with selector geometries. Added the `compress` parameter to create a gzip compressed downloadable file from the response. |
| `/collections/{collectionId}/items/{featureId}` | Added the `fields` parameter for filtering response properties. Specifically to the `/collections/uprn/items/{featureId}` endpoint, the `relationSources` and `relationSourceFields` parameters have been added to return proprety-filtered data from related views. |

## OgcApi.Net changes

This implementation relies on changes to OgcApi.Net that are not yet part of the original package and only exist in a fork. The change impacts the way OgcApi.Net implemented the `numberMatched` response element in their original code. The `numberMatched` element is used to check if a next page link is to be inserted into the response, which happens when `numberMatched` is greater than the sum of `offset` and `limit`. To know this, after a successful query, PostGIS runs `COUNT(*)` on the result and returns the value. While this is a straightforward operation, the calculation can be prohibitively expensive on large tables, such as the uprn table in our database, which contains more than 40 million rows. Thus, `/collections/{collectionId}/items` endpoints would frequently fail, especially on the uprn table, due to timeouts. The solution proposed to this is to fetch one more 
